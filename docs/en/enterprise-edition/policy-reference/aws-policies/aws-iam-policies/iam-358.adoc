== AWS GitHub Actions OIDC authorization policies allow for unsafe claims or claim order


=== Policy Details 

[width=45%]
[cols="1,1"]
|=== 
|Prisma Cloud Policy ID 
| dd4e61fb-13ae-4691-bc7c-3d98c3c0957a

|Checkov ID 
| https://github.com/bridgecrewio/checkov/tree/main/checkov/terraform/checks/data/aws/GithubActionsOIDCTrustPolicy.py[CKV_AWS_358]

|Severity
|HIGH

|Subtype
|Build

|Frameworks
|Terraform,TerraformPlan

|=== 



=== Description 


This policy ensures that AWS IAM policies using GitHub Actions OIDC authorization are configured with safe claims and claim orders to prevent potential privilege escalation or abuse. Misconfigured claims can lead to security vulnerabilities by allowing unauthorized access or unsafe token usage.

Specifically, the policy checks for:

1. Missing or invalid conditions on the `sub` variable.
2. Wildcard values or generic claims that could be abused.
3. Unsafe claim formats or orders in the `sub` variable.


=== Fix - Buildtime


*Terraform* 


* *Resource: aws_iam_policy_document*
* *Argument: principals, condition* 

To mitigate this issue, ensure the `condition` in the `aws_iam_policy_document` resource is properly configured.

- Avoid wildcards (`*`) or unsafe claim structures.
- Ensure claims follow safe and restricted formats. Abusable claims include: "workflow", "environment", "ref", "context", "head_ref", "base_ref"
- Use a specific repository reference.

Example:

[source,go]
----
data "aws_iam_policy_document" "example" {
  version = "2012-10-17"

  statement {
    effect = "Allow"
    action = [
      "sts:AssumeRoleWithWebIdentity"
    ]
    principals {
      identifiers = ["arn:aws:iam::123456123456:oidc-provider/token.actions.githubusercontent.com"]
      type        = "Federated"
    }

    condition {
      test     = "StringEquals"
-      values   = ["*"]
+      values = ["repo:myOrg/myRepo:*"]
      variable = "token.actions.githubusercontent.com:sub"
    }
  }
}
----

